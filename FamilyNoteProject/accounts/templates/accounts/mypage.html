{% extends 'accounts/a_base.html' %}
{% load static %}
{% block title %}マイページ - FamilyNote{% endblock %}
{% block content %}
<h2>マイページ</h2>
<div class="box-container">
  <div class="profile-box">
    {% comment %} <div class="profile-container"> {% endcomment %}
      {% if user.profile_image %}
        <img src="{{ user.profile_image.url }}" alt="" class="profile-image">
      {% else %}
        <p>プロフィール画像が<br>設定されていません。</p>
      {% endif %}

      <div class="profile-info">
        <p class="profile">名前: {{ user.full_name }}</p>
        <p class="profile">ニックネーム: {{ user.nickname }}</p>
        <p class="profile">あなたの家族: {{ user.family.family_name|default:"未所属" }}</p>
      </div>
    {% comment %} </div> {% endcomment %}
    <br>
    <a href="{% url 'accounts:user_edit' pk=user.id %}">📝 プロフィールを編集</a>
    <br>
    <a href="{% url 'accounts:password_change' %}">🔑 パスワードを変更する</a>
  </div>

  <div class="family-box">
    <div class="family-container">
      <h3>{{ user.family.family_name|default:"-" }} メンバー一覧</h3>
      {% if family_members %}
        <ul>
          {% for member in family_members %}
            <li>{{ member.full_name }} ({{ member.nickname }})</li>
          {% endfor %}
        </ul>
      {% else %}
        <p>家族が登録されていません。</p>
      {% endif %}

      {% if not user.family %}
        <a href="#" id="open-family-modal">家族を作成する</a>
      {% endif %}

      <a href="{% url 'families:leave_family' %}" 
         class="btn"
         {% if not user.family %}class="disabled-link"{% endif %}>
         家族を抜ける
      </a>
      <a href="{% url 'families:invite_family' %}" id="family-invite-link"
        {% if not user.family %}class="disabled-link" onclick="return false;"{% endif %}>
        家族を招待する
      </a>
      {% if not user.family %}
        <p class="notice">※ 家族を作成することで、招待や抜けるボタンが有効になります</p>
      {% endif %}
    </div>
  </div>
  
  
  <div id="family-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <form id="create-family-form" method="POST">
        <span id="close-family-modal" class="close">&times;</span>
        <h3>家族を作成</h3>
        {% csrf_token %}
        <label for="family_name">家族の名前:</label>
        <input type="text" id="family_name" name="family.family_name" required>
        <br><br>
        <button type="submit">作成</button>
      </form>
    </div>
  </div>


  <div class="child-box">
    <div class="child-container">
      <h3>{{ user.family.family_name|default:"-" }} こども一覧</h3>
      {% if children %}
        <ul id="child-list">
          {% for child in children %}
            <li>
              <a href="#" class="edit-child" data-id="{{ child.id }}">{{ child.child_name }} ({{ child.birth_date|date:"Y年m月d日" }})生まれ</a>
              <button class="delete-child" data-id="{{ child.id }}">削除</button>
            </li>
          {% endfor %}
        </ul>
      {% else %}
        <p>こどもが登録されていません。</p>
      {% endif %}
      <a href="#" id="open-child-modal">こどもを登録</a>
    </div>
  </div>
    

  <div id="child-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <form id="child-modal-form" method="POST">
        <span id="close-child-modal" class="close">&times;</span>
        <h3>こどもを登録</h3>
        {% csrf_token %}
        <label for="child_name">こどもの名前:</label>
        <input type="text" id="child_name" name="child_name" required>
        <br><br>
        <label for="birth_date">生年月日:</label>
        <input type="date" id="birth_date" name="birth_date" required>
        <br><br>
        <button type="submit">登録</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'accounts/js/modal.js' %}"></script>
{% endblock %}
