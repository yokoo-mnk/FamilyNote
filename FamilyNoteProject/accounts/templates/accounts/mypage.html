{% extends 'accounts/a_base.html' %}
{% block title %}ãƒã‚¤ãƒšãƒ¼ã‚¸ - FamilyNote{% endblock %}
{% block content %}
<h2>ãƒã‚¤ãƒšãƒ¼ã‚¸</h2>
<div class="box-container">
  <div class="profile-box">
    <div class="profile-container">
      {% if user.profile_image %}
        <img src="{{ user.profile_image.url }}" alt="" class="profile-image">
      {% else %}
        <p>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      {% endif %}

      <div class="profile-info">
        <p class="profile">åå‰: {{ user.full_name }}</p>
        <p class="profile">ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ : {{ user.nickname }}</p>
        <p class="profile">ã‚ãªãŸã®å®¶æ—: {{ user.family.name|default:"æœªæ‰€å±" }}</p>
      </div>
    </div>
    <br>
    <a href="{% url 'accounts:user_edit' pk=user.id %}">ğŸ“ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ç·¨é›†</a>
    <br>
    <a href="{% url 'accounts:password_change' %}">ğŸ”‘ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¤‰æ›´ã™ã‚‹</a>
  </div>

  <div class="family-box">
    <div class="family-container">
      <h3>{{ user.family.name|default:"ã‚ãªãŸã®å®¶æ—" }} æƒ…å ±</h3>
      {% if members %}
        <ul>
          {% for member in family_members %}
            <li>{{ member.full_name }} ({{ member.nickname }})</li>
          {% endfor %}
        </ul>
      {% else %}
        <p>å®¶æ—ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      {% endif %}

      {% if user.family %}
        <form method="post" action="{% url 'families:leave_family' %}">
          {% csrf_token %}
          <button type="submit">å®¶æ—ã‚’æŠœã‘ã‚‹</button>
        </form>
      {% endif %}

      {% if user.family %}
        <a href="{% url 'families:invite_family' %}">å®¶æ—ã‚’æ‹›å¾…ã™ã‚‹</a>
      {% else %}
        <a href="{% url 'families:create_family' %}">å®¶æ—ã‚’ä½œæˆã™ã‚‹</a>
      {% endif %}
    </div>
  </div>
  <div class="child-box">
    <div class="child-container">
      <h3>{{ user.family.name|default:"ã‚ãªãŸã®å®¶æ—" }} ã“ã©ã‚‚æƒ…å ±</h3>
      {% if children %}
        <ul>
          {% for child in children %}
          <li>{{ child.child_name }} ({{ child.birth_date|date:"Yå¹´mæœˆdæ—¥" }})</li>
            <a href="#" class="edit-child" data-id="{{ child.id }}">{{ child.name }} ({{ child.birth_date }})</a>
            <button class="delete-child" data-id="{{ child.id }}">å‰Šé™¤</button>
          {% endfor %}
        </ul>
      {% else %}
        <p>ã“ã©ã‚‚ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
      {% endif %}
    </div>
    <div id="child-modal" style="display: none;">
      <div id="modal-content">
        <span id="close-modal">&times;</span>
        <h3>ã“ã©ã‚‚ã‚’ç™»éŒ²</h3>
        <div id="modal-form-container"></div>
      </div>
    </div>
  </div> 
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const modal = document.getElementById("child-modal");
    const modalContent = document.getElementById("modal-form-container");
  
    document.getElementById("open-modal").addEventListener("click", function () {
      fetch("{% url 'accounts:add_child' %}")
        .then(response => response.text())
        .then(html => {
          modalContent.innerHTML = html;
          modal.style.display = "block";
        });
    });
  
    document.querySelectorAll(".edit-child").forEach(btn => {
      btn.addEventListener("click", function () {
        fetch(`/accounts/edit_child/${btn.dataset.id}/`)
          .then(response => response.text())
          .then(html => {
            modalContent.innerHTML = html;
            modal.style.display = "block";
          });
      });
    });
  
    document.querySelectorAll(".delete-child").forEach(btn => {
      btn.addEventListener("click", function () {
        if (confirm("ã“ã®å­ä¾›æƒ…å ±ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
          fetch(`/accounts/delete_child/${btn.dataset.id}/`, { method: "POST" })
            .then(response => response.json())
            .then(data => {
              if (data.status === "deleted") {
                location.reload();
              }
            });
        }
      });
    });
  
    document.getElementById("close-modal").addEventListener("click", function () {
      modal.style.display = "none";
    });
  });
</script>
{% endblock %}